<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>articles/nginx-load-balancing | agent-swarm-kit</title><meta name="description" content="Documentation for agent-swarm-kit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">agent-swarm-kit</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">agent-swarm-kit</a></li><li><a href="articles_nginx-load-balancing.html">articles/nginx-load-balancing</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="load-balancing-llm-with-nginx" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Load Balancing LLM with Nginx<a href="#load-balancing-llm-with-nginx" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>There are plenty of examples online showing how to connect ChatGPT 3.5 to a Telegram bot without tools. However, when it comes to handling a large number of users, there are no examples of distributing the load across multiple processes: all tutorials on the internet launch a monolith with a single replica.</p>
<p><img src="../media/d696be48fa6cf4826ae7b3c03c08a7c7.png" alt="Image"><br>
<em>Caption: <a href="https://github.com/telegraf/telegraf/issues/423">https://github.com/telegraf/telegraf/issues/423</a></em></p>
<p>Additionally, in my experience with NodeJS, I’ve encountered issues where a large number of <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promises in a pending state</a> slow down the application due to the burden on the garbage collector. <a href="https://platform.openai.com/docs/guides/function-calling">Adding third-party tools</a> (e.g., allowing ChatGPT to call external functions with database queries) requires at least thinking about creating replicas of the monolith to avoid inflating the queue waiting for database data.</p>
<a id="application-architecture" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Application Architecture<a href="#application-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>For load balancing, the most obvious tool is <a href="https://codeforgeek.com/load-balancing-nodejs-servers-nginx/">Nginx upstream</a>. This tool receives a WebSocket connection from a new client on port 80 and proxies it in a round-robin fashion to ports 8081, 8082, ..., 8085, depending on the number of replicas. If a client remains inactive for 15 minutes, the connection is terminated; if a new message arrives, a new connection is established.</p>
<p><img src="../media/03548f724f9102c0a90e8450fb62c7af.png" alt="Image"><br>
<em>Caption: <a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html">https://nginx.org/en/docs/http/ngx_http_upstream_module.html</a></em></p>
<p>Replicas store the chat history in Redis, allowing the context to be restored even if a new process handles the messages. Replicas will be created using <a href="https://pm2.io/">PM2</a>, the most native approach for NodeJS stack applications.</p>
<p><img src="../media/95c4ac7836cd109ba2b5709e95cc8474.png" alt="Image"><br>
<em>Caption: <a href="https://pm2.io/docs/plus/overview/">https://pm2.io/docs/plus/overview/</a></em></p>
<p>Additionally, with PM2, for $40/month, you can purchase ready-made incident notifications via Slack/Email and server monitoring with standard metrics such as CPUs (cores, hardware threads, virtual threads), memory capacity, network interfaces, storage devices (I/O, capacity), response time, etc. This saves money on DevOps until the project becomes self-sustaining.</p>
<a id="configuration-files" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Configuration Files<a href="#configuration-files" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>To avoid tailoring the developer’s Linux machine to a single project, we’ll wrap Nginx in Docker. For this, let’s write a <code>docker-compose.yaml</code>:</p>
<pre><code class="yaml"><span class="hl-12">version</span><span class="hl-1">: </span><span class="hl-13">&#39;3.8&#39;</span><br/><br/><span class="hl-12">services</span><span class="hl-1">:</span><br/><span class="hl-1">  </span><span class="hl-12">nginx</span><span class="hl-1">:</span><br/><span class="hl-1">    </span><span class="hl-12">image</span><span class="hl-1">: </span><span class="hl-13">nginx:1.27.4</span><br/><span class="hl-1">    </span><span class="hl-12">ports</span><span class="hl-1">:</span><br/><span class="hl-1">      - </span><span class="hl-3">&quot;80:80&quot;</span><br/><span class="hl-1">    </span><span class="hl-12">extra_hosts</span><span class="hl-1">:</span><br/><span class="hl-1">      - </span><span class="hl-3">&quot;host.docker.internal:host-gateway&quot;</span><br/><span class="hl-1">    </span><span class="hl-12">volumes</span><span class="hl-1">:</span><br/><span class="hl-1">      - </span><span class="hl-13">./config/nginx.conf:/etc/nginx/nginx.conf:ro</span><br/><span class="hl-1">      - </span><span class="hl-13">./logs/nginx:/var/log/nginx</span>
</code><button type="button">Copy</button></pre>

<p>And create the accompanying <code>./config/nginx.conf</code> with the list of replicas:</p>
<pre><code class="nginx">user nginx;
worker_processes auto;

error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    upstream local_websocket_servers {
        server host.docker.internal:8081;  # Using host.docker.internal from hosts shared from host machine
        server host.docker.internal:8082;
        server host.docker.internal:8083;
        server host.docker.internal:8084;
        server host.docker.internal:8085;
        least_conn;
    }

    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    server {
        listen 80;
        server_name localhost;

        location / {
            proxy_pass http://local_websocket_servers$is_args$args;

            # WebSocket-specific headers
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;

            # Preserve original headers and connection details
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Close upstream if client disconnects
            proxy_ignore_client_abort on;

            # Long-lived connection settings
            proxy_read_timeout 86400s;
            proxy_send_timeout 86400s;

            # Buffer and performance settings
            proxy_buffer_size 128k;
            proxy_buffers 4 256k;
            proxy_busy_buffers_size 256k;
        }
    }
}
</code><button type="button">Copy</button></pre>

<p>To launch replicas via PM2, we’ll create a <code>pm2.config.cjs</code>. <a href="https://github.com/tripolskypetr/agent-swarm-kit/blob/master/demo/nginx-balancer-chat/package.json">Here’s the package.json</a> with scripts to start the project via <code>npm start</code>:</p>
<pre><code class="javascript"><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-6">path</span><span class="hl-1"> = </span><span class="hl-0">require</span><span class="hl-1">(</span><span class="hl-3">&quot;path&quot;</span><span class="hl-1">);</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-6">os</span><span class="hl-1"> = </span><span class="hl-0">require</span><span class="hl-1">(</span><span class="hl-3">&quot;os&quot;</span><span class="hl-1">);</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-6">dotenv</span><span class="hl-1"> = </span><span class="hl-0">require</span><span class="hl-1">(</span><span class="hl-3">&#39;dotenv&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-0">readConfig</span><span class="hl-1"> = () </span><span class="hl-4">=&gt;</span><span class="hl-1"> </span><span class="hl-2">dotenv</span><span class="hl-1">.</span><span class="hl-0">parse</span><span class="hl-1">(</span><span class="hl-3">&quot;./.env&quot;</span><span class="hl-1">);</span><br/><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-0">getPath</span><span class="hl-1"> = (</span><span class="hl-2">unixPath</span><span class="hl-1">) </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-5">return</span><span class="hl-1"> </span><span class="hl-2">path</span><span class="hl-1">.</span><span class="hl-0">resolve</span><span class="hl-1">(</span><span class="hl-2">unixPath</span><span class="hl-1">.</span><span class="hl-0">replace</span><span class="hl-1">(</span><span class="hl-3">&#39;~&#39;</span><span class="hl-1">, </span><span class="hl-2">os</span><span class="hl-1">.</span><span class="hl-0">homedir</span><span class="hl-1">()));</span><br/><span class="hl-1">};</span><br/><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-0">createBun</span><span class="hl-1"> = (</span><span class="hl-2">index</span><span class="hl-1">) </span><span class="hl-4">=&gt;</span><span class="hl-1"> ({</span><br/><span class="hl-1">  </span><span class="hl-2">name:</span><span class="hl-1"> </span><span class="hl-3">`bun-ws-</span><span class="hl-4">${</span><span class="hl-2">index</span><span class="hl-4">}</span><span class="hl-3">`</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">script:</span><span class="hl-1"> </span><span class="hl-3">&quot;./src/server.ts&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">interpreter:</span><span class="hl-1"> </span><span class="hl-0">getPath</span><span class="hl-1">(</span><span class="hl-3">&quot;~/.bun/bin/bun&quot;</span><span class="hl-1">),</span><br/><span class="hl-1">  </span><span class="hl-2">args:</span><span class="hl-1"> [</span><span class="hl-3">&quot;--server&quot;</span><span class="hl-1">, </span><span class="hl-3">`--port=808</span><span class="hl-4">${</span><span class="hl-2">index</span><span class="hl-4">}</span><span class="hl-3">`</span><span class="hl-1">],</span><br/><span class="hl-1">  </span><span class="hl-2">out_file:</span><span class="hl-1"> </span><span class="hl-3">`./logs/pm2/bun-ws-</span><span class="hl-4">${</span><span class="hl-2">index</span><span class="hl-4">}</span><span class="hl-3">-out.log`</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">error_file:</span><span class="hl-1"> </span><span class="hl-3">`./logs/pm2/bun-ws-</span><span class="hl-4">${</span><span class="hl-2">index</span><span class="hl-4">}</span><span class="hl-3">-error.log`</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">log_date_format:</span><span class="hl-1"> </span><span class="hl-3">&quot;YYYY-MM-DD HH:mm:ss&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">merge_logs:</span><span class="hl-1"> </span><span class="hl-4">true</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">env:</span><span class="hl-1"> </span><span class="hl-0">readConfig</span><span class="hl-1">(),</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-7">module</span><span class="hl-1">.</span><span class="hl-7">exports</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-2">apps:</span><span class="hl-1"> [</span><br/><span class="hl-1">    </span><span class="hl-9">/*</span><br/><span class="hl-9">    {</span><br/><span class="hl-9">      name: &quot;bun-ws-1&quot;,</span><br/><span class="hl-9">      script: &quot;./src/server.ts&quot;,</span><br/><span class="hl-9">      interpreter: getPath(&quot;~/.bun/bin/bun&quot;),</span><br/><span class="hl-9">      args: [&quot;--server&quot;, &quot;--port=8081&quot;],</span><br/><span class="hl-9">      out_file: &quot;./logs/pm2/bun-ws-1-out.log&quot;,</span><br/><span class="hl-9">      error_file: &quot;./logs/pm2/bun-ws-1-error.log&quot;,</span><br/><span class="hl-9">      log_date_format: &quot;YYYY-MM-DD HH:mm:ss&quot;,</span><br/><span class="hl-9">      merge_logs: true,</span><br/><span class="hl-9">    },</span><br/><span class="hl-9">    */</span><br/><span class="hl-1">    </span><span class="hl-0">createBun</span><span class="hl-1">(</span><span class="hl-8">1</span><span class="hl-1">),</span><br/><span class="hl-1">    </span><span class="hl-0">createBun</span><span class="hl-1">(</span><span class="hl-8">2</span><span class="hl-1">),</span><br/><span class="hl-1">    </span><span class="hl-0">createBun</span><span class="hl-1">(</span><span class="hl-8">3</span><span class="hl-1">),</span><br/><span class="hl-1">    </span><span class="hl-0">createBun</span><span class="hl-1">(</span><span class="hl-8">4</span><span class="hl-1">),</span><br/><span class="hl-1">    </span><span class="hl-0">createBun</span><span class="hl-1">(</span><span class="hl-8">5</span><span class="hl-1">),</span><br/><span class="hl-1">  ]</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>As you can see, we pass the port number for orchestration via command-line arguments. This is convenient because the <code>.env</code> file remains static and doesn’t change at runtime. To run the project, we use <a href="https://bun.sh/">Bun</a>, a faster alternative to NodeJS, comparable in speed to Golang.</p>
<a id="agent-swarm" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Agent Swarm<a href="#agent-swarm" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>An agent is analogous to a scene in Telegraf—a model LLM using an isolated system prompt. The current agent in the Swarm can be changed via the <code>changeToAgent</code> function, similar to navigating scenes in a Telegram bot after clicking a button.</p>
<pre><code class="typescript"><span class="hl-5">import</span><span class="hl-1"> { </span><span class="hl-2">Adapter</span><span class="hl-1">, </span><span class="hl-2">addAgent</span><span class="hl-1">, </span><span class="hl-2">addCompletion</span><span class="hl-1">, </span><span class="hl-2">addSwarm</span><span class="hl-1"> } </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-3">&quot;agent-swarm-kit&quot;</span><span class="hl-1">;</span><br/><span class="hl-5">import</span><span class="hl-1"> { </span><span class="hl-2">OpenAI</span><span class="hl-1"> } </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-3">&quot;openai&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-5">export</span><span class="hl-1"> </span><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-6">OPENAI_COMPLETION</span><span class="hl-1"> = </span><span class="hl-0">addCompletion</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-2">completionName:</span><span class="hl-1"> </span><span class="hl-3">&quot;openai_completion&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">getCompletion:</span><span class="hl-1"> </span><span class="hl-2">Adapter</span><span class="hl-1">.</span><span class="hl-0">fromOpenAI</span><span class="hl-1">(</span><span class="hl-4">new</span><span class="hl-1"> </span><span class="hl-0">OpenAI</span><span class="hl-1">({ </span><span class="hl-2">apiKey:</span><span class="hl-1"> </span><span class="hl-2">process</span><span class="hl-1">.</span><span class="hl-2">env</span><span class="hl-1">.</span><span class="hl-6">OPENAI_API_KEY</span><span class="hl-1"> }))</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">export</span><span class="hl-1"> </span><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-6">TEST_AGENT</span><span class="hl-1"> = </span><span class="hl-0">addAgent</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-2">docDescription:</span><span class="hl-1"> </span><span class="hl-3">&quot;This agent operates within the nginx-balancer-chat project as a test agent, utilizing the OpenaiCompletion to inform users about the actual server port of one of 5 chat instances running on different ports and upstreamed by Nginx to port 80, extracting the port details from the chat history’s system message.&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">agentName:</span><span class="hl-1"> </span><span class="hl-3">&quot;test_agent&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">completion:</span><span class="hl-1"> </span><span class="hl-6">OPENAI_COMPLETION</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">prompt:</span><span class="hl-1"> </span><span class="hl-3">`You are a test agent for Nginx Upstream. Tell user the server port from the chat history (system message)`</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">dependsOn:</span><span class="hl-1"> [],</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-5">export</span><span class="hl-1"> </span><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-6">TEST_SWARM</span><span class="hl-1"> = </span><span class="hl-0">addSwarm</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-2">docDescription:</span><span class="hl-1"> </span><span class="hl-3">&quot;This swarm serves as the core structure for the nginx-balancer-chat project, managing a single TestAgent as both the sole member and default agent to handle user interactions, leveraging the CohereCompletion to report the specific port of one of 5 upstreamed chat instances balanced by Nginx to port 80.&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">swarmName:</span><span class="hl-1"> </span><span class="hl-3">&quot;test_swarm&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">agentList:</span><span class="hl-1"> [</span><span class="hl-6">TEST_AGENT</span><span class="hl-1">],</span><br/><span class="hl-1">  </span><span class="hl-2">defaultAgent:</span><span class="hl-1"> </span><span class="hl-6">TEST_AGENT</span><span class="hl-1">,</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p>The code in this example is programmed so that the LLM model reports which port the WebSocket request was proxied from. Instead of <code>OPENAI_COMPLETION</code>, you can use <code>LMStudio</code>, <code>Ollama</code>, or <code>Cohere</code> for individual agents—see the repository for more details.</p>
<pre><code class="typescript"><span class="hl-5">import</span><span class="hl-1"> { </span><span class="hl-2">Chat</span><span class="hl-1">, </span><span class="hl-2">getAgentName</span><span class="hl-1">, </span><span class="hl-2">Schema</span><span class="hl-1">, </span><span class="hl-2">History</span><span class="hl-1"> } </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-3">&quot;agent-swarm-kit&quot;</span><span class="hl-1">;</span><br/><span class="hl-5">import</span><span class="hl-1"> </span><span class="hl-5">type</span><span class="hl-1"> { </span><span class="hl-2">ServerWebSocket</span><span class="hl-1"> } </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-3">&quot;bun&quot;</span><span class="hl-1">;</span><br/><span class="hl-5">import</span><span class="hl-1"> { </span><span class="hl-2">parseArgs</span><span class="hl-1"> } </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-3">&quot;util&quot;</span><span class="hl-1">;</span><br/><span class="hl-5">import</span><span class="hl-1"> { </span><span class="hl-2">TEST_SWARM</span><span class="hl-1"> } </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-3">&quot;./lib/swarm&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-4">declare</span><span class="hl-1"> </span><span class="hl-4">function</span><span class="hl-1"> </span><span class="hl-0">parseInt</span><span class="hl-1">(</span><span class="hl-2">value</span><span class="hl-1">: </span><span class="hl-7">unknown</span><span class="hl-1">): </span><span class="hl-7">number</span><span class="hl-1">;</span><br/><br/><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-7">WebSocketData</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-2">clientId</span><span class="hl-1">: </span><span class="hl-7">string</span><span class="hl-1">;</span><br/><span class="hl-1">};</span><br/><br/><span class="hl-4">const</span><span class="hl-1"> { </span><span class="hl-6">values</span><span class="hl-1"> } = </span><span class="hl-0">parseArgs</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-2">args:</span><span class="hl-1"> </span><span class="hl-2">process</span><span class="hl-1">.</span><span class="hl-2">argv</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">options:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-2">server:</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-2">type:</span><span class="hl-1"> </span><span class="hl-3">&quot;boolean&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-2">port:</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-2">type:</span><span class="hl-1"> </span><span class="hl-3">&quot;string&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-2">strict:</span><span class="hl-1"> </span><span class="hl-4">true</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">allowPositionals:</span><span class="hl-1"> </span><span class="hl-4">true</span><span class="hl-1">,</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-2">History</span><span class="hl-1">.</span><span class="hl-0">useHistoryCallbacks</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-0">getSystemPrompt</span><span class="hl-2">:</span><span class="hl-1"> () </span><span class="hl-4">=&gt;</span><span class="hl-1"> [</span><br/><span class="hl-1">    </span><span class="hl-3">`The server port is </span><span class="hl-4">${</span><span class="hl-6">SERVER_PORT</span><span class="hl-4">}</span><span class="hl-3">. Tell him that port ASAP`</span><br/><span class="hl-1">  ]</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-6">SERVER_PORT</span><span class="hl-1"> = </span><span class="hl-0">parseInt</span><span class="hl-1">(</span><span class="hl-2">values</span><span class="hl-1">.</span><span class="hl-2">port</span><span class="hl-1">);</span><br/><br/><span class="hl-5">if</span><span class="hl-1"> (</span><span class="hl-0">isNaN</span><span class="hl-1">(</span><span class="hl-6">SERVER_PORT</span><span class="hl-1">)) {</span><br/><span class="hl-1">  </span><span class="hl-5">throw</span><span class="hl-1"> </span><span class="hl-4">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-3">`Server port is not a number: </span><span class="hl-4">${</span><span class="hl-2">values</span><span class="hl-10">.</span><span class="hl-2">port</span><span class="hl-4">}</span><span class="hl-3">`</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">if</span><span class="hl-1"> (</span><span class="hl-2">values</span><span class="hl-1">.</span><span class="hl-2">server</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-2">Bun</span><span class="hl-1">.</span><span class="hl-0">serve</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-2">req</span><span class="hl-1">, </span><span class="hl-2">server</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-6">clientId</span><span class="hl-1"> = </span><span class="hl-4">new</span><span class="hl-1"> </span><span class="hl-0">URL</span><span class="hl-1">(</span><span class="hl-2">req</span><span class="hl-1">.</span><span class="hl-2">url</span><span class="hl-1">).</span><span class="hl-2">searchParams</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-3">&quot;clientId&quot;</span><span class="hl-1">)!;</span><br/><span class="hl-1">      </span><span class="hl-5">if</span><span class="hl-1"> (!</span><span class="hl-2">clientId</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-5">return</span><span class="hl-1"> </span><span class="hl-4">new</span><span class="hl-1"> </span><span class="hl-0">Response</span><span class="hl-1">(</span><span class="hl-3">&quot;Invalid clientId&quot;</span><span class="hl-1">, { </span><span class="hl-2">status:</span><span class="hl-1"> </span><span class="hl-8">500</span><span class="hl-1"> });</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">      </span><span class="hl-2">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-3">`Connected clientId=</span><span class="hl-4">${</span><span class="hl-2">clientId</span><span class="hl-4">}</span><span class="hl-3"> port=</span><span class="hl-4">${</span><span class="hl-6">SERVER_PORT</span><span class="hl-4">}</span><span class="hl-3">`</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-2">server</span><span class="hl-1">.</span><span class="hl-0">upgrade</span><span class="hl-1">&lt;</span><span class="hl-7">WebSocketData</span><span class="hl-1">&gt;(</span><span class="hl-2">req</span><span class="hl-1">, {</span><br/><span class="hl-1">        </span><span class="hl-2">data:</span><span class="hl-1"> {</span><br/><span class="hl-1">          </span><span class="hl-2">clientId</span><span class="hl-1">,</span><br/><span class="hl-1">        },</span><br/><span class="hl-1">      });</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-2">websocket:</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">open</span><span class="hl-1">(</span><span class="hl-2">ws</span><span class="hl-1">: </span><span class="hl-7">ServerWebSocket</span><span class="hl-1">&lt;</span><span class="hl-7">WebSocketData</span><span class="hl-1">&gt;) {</span><br/><span class="hl-1">        </span><span class="hl-5">await</span><span class="hl-1"> </span><span class="hl-2">Chat</span><span class="hl-1">.</span><span class="hl-0">beginChat</span><span class="hl-1">(</span><span class="hl-2">ws</span><span class="hl-1">.</span><span class="hl-2">data</span><span class="hl-1">.</span><span class="hl-2">clientId</span><span class="hl-1">, </span><span class="hl-6">TEST_SWARM</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-5">await</span><span class="hl-1"> </span><span class="hl-2">Schema</span><span class="hl-1">.</span><span class="hl-0">writeSessionMemory</span><span class="hl-1">(</span><span class="hl-2">ws</span><span class="hl-1">.</span><span class="hl-2">data</span><span class="hl-1">.</span><span class="hl-2">clientId</span><span class="hl-1">, { </span><span class="hl-2">port:</span><span class="hl-1"> </span><span class="hl-6">SERVER_PORT</span><span class="hl-1"> });</span><br/><span class="hl-1">      },</span><br/><span class="hl-1">      </span><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">message</span><span class="hl-1">(</span><span class="hl-2">ws</span><span class="hl-1">: </span><span class="hl-7">ServerWebSocket</span><span class="hl-1">&lt;</span><span class="hl-7">WebSocketData</span><span class="hl-1">&gt;, </span><span class="hl-2">message</span><span class="hl-1">: </span><span class="hl-7">string</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-6">answer</span><span class="hl-1"> = </span><span class="hl-5">await</span><span class="hl-1"> </span><span class="hl-2">Chat</span><span class="hl-1">.</span><span class="hl-0">sendMessage</span><span class="hl-1">(</span><span class="hl-2">ws</span><span class="hl-1">.</span><span class="hl-2">data</span><span class="hl-1">.</span><span class="hl-2">clientId</span><span class="hl-1">, </span><span class="hl-2">message</span><span class="hl-1">, </span><span class="hl-6">TEST_SWARM</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-2">ws</span><span class="hl-1">.</span><span class="hl-0">send</span><span class="hl-1">(</span><br/><span class="hl-1">          </span><span class="hl-6">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">({</span><br/><span class="hl-1">            </span><span class="hl-2">data:</span><span class="hl-1"> </span><span class="hl-2">answer</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-2">agentName:</span><span class="hl-1"> </span><span class="hl-5">await</span><span class="hl-1"> </span><span class="hl-0">getAgentName</span><span class="hl-1">(</span><span class="hl-2">ws</span><span class="hl-1">.</span><span class="hl-2">data</span><span class="hl-1">.</span><span class="hl-2">clientId</span><span class="hl-1">),</span><br/><span class="hl-1">          })</span><br/><span class="hl-1">        );</span><br/><span class="hl-1">      },</span><br/><span class="hl-1">      </span><span class="hl-4">async</span><span class="hl-1"> </span><span class="hl-0">close</span><span class="hl-1">(</span><span class="hl-2">ws</span><span class="hl-1">: </span><span class="hl-7">ServerWebSocket</span><span class="hl-1">&lt;</span><span class="hl-7">WebSocketData</span><span class="hl-1">&gt;) {</span><br/><span class="hl-1">        </span><span class="hl-2">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-3">`Disconnected clientId=</span><span class="hl-4">${</span><span class="hl-2">ws</span><span class="hl-10">.</span><span class="hl-2">data</span><span class="hl-10">.</span><span class="hl-2">clientId</span><span class="hl-4">}</span><span class="hl-3"> port=</span><span class="hl-4">${</span><span class="hl-6">SERVER_PORT</span><span class="hl-4">}</span><span class="hl-3">`</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-5">await</span><span class="hl-1"> </span><span class="hl-2">Chat</span><span class="hl-1">.</span><span class="hl-0">dispose</span><span class="hl-1">(</span><span class="hl-2">ws</span><span class="hl-1">.</span><span class="hl-2">data</span><span class="hl-1">.</span><span class="hl-2">clientId</span><span class="hl-1">, </span><span class="hl-6">TEST_SWARM</span><span class="hl-1">);</span><br/><span class="hl-1">      },</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-2">port:</span><span class="hl-1"> </span><span class="hl-6">SERVER_PORT</span><span class="hl-1">,</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-2">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-3">`Server listening http://localhost:</span><span class="hl-4">${</span><span class="hl-6">SERVER_PORT</span><span class="hl-4">}</span><span class="hl-3">`</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>If you’re interested in developing chats with more than one agent, <a href="https://agent-swarm.github.io/documents/docs_getting-started.html">check out the documentation</a>.</p>
<a id="thank-you-for-your-attention" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Thank You for Your Attention!<a href="#thank-you-for-your-attention" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2></div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#load-balancing-llm-with-nginx"><span>Load <wbr/>Balancing LLM with <wbr/>Nginx</span></a><ul><li><a href="#application-architecture"><span>Application <wbr/>Architecture</span></a></li><li><a href="#configuration-files"><span>Configuration <wbr/>Files</span></a></li><li><ul><li><a href="#agent-swarm"><span>Agent <wbr/>Swarm</span></a></li></ul></li><li><a href="#thank-you-for-your-attention"><span>Thank <wbr/>You for <wbr/>Your <wbr/>Attention!</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">agent-swarm-kit</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();
   for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
   k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(100273846, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true,
        webvisor:true,
        ecommerce:"dataLayer"
   });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/100273846" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-85RYYZDT35"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-85RYYZDT35');
</script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();
   for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
   k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(100273846, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true,
        webvisor:true,
        ecommerce:"dataLayer"
   });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/100273846" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-85RYYZDT35"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-85RYYZDT35');
</script>
